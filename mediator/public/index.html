<!DOCTYPE html>
<html lang="en">
<head>
  <title>DHIS Export</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
</head>
<body>
  <div id="app"></div>

  <script type="text/javascript" src="https://unpkg.com/vue@2.5.8/dist/vue.js"></script>

  <script type="text/x-template" id="app-template">
    <main class="container">
      <h1>DHIS Export</h1>
      <export-form @submit="onSubmit" />
    </main>
  </script>

  <script type="text/x-template" id="export-form-template">
    <form @submit.prevent="onSubmit">
      <div class="form-group">
        <label>Org Unit</label>
        <div v-if="fetchingOrgUnits">Loading...</div>
        <select v-model="selectedOrgUnit" v-else autofocus required class="form-control" ref="orgUnit">
          <option disabled value="">Select...</option>
          <option v-for="orgUnit in orgUnits" :value="orgUnit.id">
            {{orgUnit.displayName}}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label>Data Set</label>
        <div v-if="fetchingDataSets">Loading...</div>
        <select v-model="selectedDataSet" v-else required class="form-control">
          <option disabled value="">Select...</option>
          <option v-for="dataSet in dataSets" :value="dataSet.id">
            {{dataSet.displayName}}
          </option>
        </select>
      </div>

      <div class="form-row">
        <div class="form-group col">
          <label>Start Date</label>
          <input type="date" v-model="selectedStartDate" required class="form-control" />
        </div>
        <div class="form-group col">
          <label>End Date</label>
          <input type="date" v-model="selectedEndDate" required class="form-control" />
        </div>
      </div>

      <button type="submit" class="btn btn-primary">Export</button>
    </form>
  </script>

  <script type="text/javascript">
    function expectStatus(status) {
      return (res) => {
        if (res.status !== status) {
          throw new Error(`Unexpected status code: ${res.status}`)
        }
        return res.json()
      }
    }
    const ExportForm = {
      template: '#export-form-template',
      data() {
        return {
          // Org unit fields
          fetchingOrgUnits: false,
          orgUnits: [],
          selectedOrgUnit: '',
          // Data set fields
          fetchingDataSets: false,
          dataSets: [],
          selectedDataSet: '',
          // Date range fields
          selectedStartDate: '2017-01-01',
          selectedEndDate: '2017-12-31'
        }
      },
      beforeMount() {
        this.fetchOrgUnits()
        this.fetchDataSets()
      },
      methods: {
        fetchOrgUnits() {
          this.fetchingOrgUnits = true
          fetch('http://localhost:3000/orgUnits')
            .then(expectStatus(200))
            .then((orgUnits) => {
              this.fetchingOrgUnits = false
              this.orgUnits = orgUnits
              this.$nextTick(() => {
                this.$refs.orgUnit.focus()
              })
            }).catch((err) => {
              this.fetchingOrgUnits = false
              console.error(err)
            })
        },

        fetchDataSets() {
          this.fetchingDataSets = true
          fetch('http://localhost:3000/dataSets')
            .then(expectStatus(200))
            .then((dataSets) => {
              this.fetchingDataSets = false
              this.dataSets = dataSets
            }).catch((err) => {
              this.fetchingDataSets = false
              console.error(err)
            })
        },

        onSubmit() {
          this.$emit('submit', {
            orgUnit: this.selectedOrgUnit,
            dataSet: this.selectedDataSet,
            startDate: this.selectedStartDate,
            endDate: this.selectedEndDate
          })
        }
      }
    }

    const vue = new Vue({
      el: '#app',
      template: '#app-template',
      components: {
        'export-form': ExportForm
      },
      methods: {
        onSubmit(data) {
          console.log('Submitted', data)
        }
      }
    })
  </script>
</body>
</html>
